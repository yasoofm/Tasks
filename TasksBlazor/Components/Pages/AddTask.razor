@page "/AddTask"
@inject NavigationManager Navigation

<TelerikForm Model="@Model" Width="50%" OnValidSubmit="@HandleValidSubmit">
    <FormValidation>
        <DataAnnotationsValidator></DataAnnotationsValidator>
    </FormValidation>
    <FormItems>
        <FormItem Field="@nameof(Model.Subject)"></FormItem>
        <FormItem Field="@nameof(Model.Description)">
            <Template>
                <label for="desc" class="k-label k-form-label">Description</label>
                <TelerikTextArea @bind-Value="Model!.Description"></TelerikTextArea>
            </Template>
        </FormItem>
        <FormItem Field="@nameof(Model.Priority)">
            <Template>
                <label for="prio" class="k-label k-form-label">Priority</label>
                <TelerikRadioGroup 
                    Id="prio" Data="@priorities"
                    @bind-Value="@Model!.Priority"
                    Layout="RadioGroupLayout.Horizontal">
                </TelerikRadioGroup>
            </Template>
        </FormItem>
        <FormItem Field="@nameof(Model.Status)">
            <Template>
                <label for="stat" class="k-label k-form-label">Status</label>
                <TelerikRadioGroup 
                    Id="stat" Data="@statuses"
                    @bind-Value="@Model!.Status"
                    TextField="@nameof(Status.Name)"
                    ValueField="@nameof(Status.Value)"
                    Layout="RadioGroupLayout.Horizontal">
                </TelerikRadioGroup>
            </Template>
        </FormItem>
        @if (State!.IsAdmin)
        {
            <FormItem Field="@nameof(Model.AssignedTo)">

            </FormItem>
        }
    </FormItems>
</TelerikForm>
<TelerikLoader Visible="@LoaderVisible" />


@code {
    [CascadingParameter] GlobalAppState? State { get; set; }
    private AddTaskRequest? Model { get; set; } = new AddTaskRequest();
    private List<string> priorities { get; set; } = [Priority.Low.ToString(), Priority.Medium.ToString(), Priority.High.ToString()];
    private List<Status> statuses { get; set; } = [Status.ToDo, Status.InProgress, Status.Done];
    private bool LoaderVisible { set; get; } = false;

    async void HandleValidSubmit()
    {
        try
        {
            LoaderVisible = true;
            StateHasChanged();

            if (State == null)
            {
                throw new NullReferenceException("State is null in AddTask page");
            }

            var client = State.CreateClient();
            var response = await client.PostAsJsonAsync("Tasks", Model);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GetTaskResponse>();
                State.AddTicket(result!);
                LoaderVisible = false;
                StateHasChanged();
                Navigation.NavigateTo("/");
            }
            
        }
        catch (NullReferenceException ex)
        {
            LoaderVisible = false;
            StateHasChanged();
            Console.WriteLine(ex);
        }
        catch (HttpRequestException ex)
        {
            LoaderVisible = false;
            StateHasChanged();
            Console.WriteLine(ex);
        }
        catch (System.Text.Json.JsonException ex)
        {
            LoaderVisible = false;
            StateHasChanged();
            Console.WriteLine("AddTask response serialization failed\n" + ex);
        }
    }
}